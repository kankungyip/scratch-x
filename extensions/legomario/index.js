const{ArgumentType,BlockType}=Scratch,WebBLE=Scratch.IO["WebBLE"],{Base64Util,Cast,MathUtil,RateLimiter}=Scratch.Util,blockIconURI="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNDBweCIgaGVpZ2h0PSI0MHB4IiB2aWV3Qm94PSIwIDAgNDAgNDAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDU5LjEgKDg2MTQ0KSAtIGh0dHBzOi8vc2tldGNoLmNvbSAtLT4KICAgIDx0aXRsZT5sZWdvbWFyaW8tc21hbGw8L3RpdGxlPgogICAgPGRlc2M+Q3JlYXRlZCB3aXRoIFNrZXRjaC48L2Rlc2M+CiAgICA8ZyBpZD0ibGVnb21hcmlvLXNtYWxsIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8Y2lyY2xlIGlkPSJPdmFsIiBmaWxsPSIjRkZGRkZGIiBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiPjwvY2lyY2xlPgogICAgICAgIDxwb2x5bGluZSBpZD0iUGF0aC0yIiBmaWxsPSIjRkYwMDAwIiBwb2ludHM9IjIwIDE0LjQ2NDk2OTggMTIuNjE0MTYzMyA1Ljg5NzkzMzQ3IDMuMTMzODIwNTYgMjUuMzYyMzk5MiA5LjE2MTI5MDMyIDMwLjMwNjE5OTYgMTQuMTg4NTA4MSAxNS41MTI2MDA4IDIwIDIyLjY2MDUzNDMiPjwvcG9seWxpbmU+CiAgICAgICAgPHBvbHlsaW5lIGlkPSJQYXRoLTItQ29weSIgZmlsbD0iI0ZGMDAwMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjguNDMzMDkwLCAxOC4xMDIwNjcpIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTI4LjQzMzA5MCwgLTE4LjEwMjA2NykgIiBwb2ludHM9IjM2Ljg2NjE3OTQgMTQuNDY0OTY5OCAyOS40ODAzNDI3IDUuODk3OTMzNDcgMjAgMjUuMzYyMzk5MiAyNi4wMjc0Njk4IDMwLjMwNjE5OTYgMzEuMDU0Njg3NSAxNS41MTI2MDA4IDM2Ljg2NjE3OTQgMjIuNjYwNTM0MyI+PC9wb2x5bGluZT4KICAgIDwvZz4KPC9zdmc+",BLETimeout=4500,BLEDataStoppedError="lego mario extension stopped receiving data",MarioBLE={service:"00001623-1212-efde-1623-785feabcd123",characteristic:"00001624-1212-efde-1623-785feabcd123",sendRateMax:20},MarioIO={COLOR_BARCODE_SENSOR:73,PANTS:74},MessageType={HUB_PROPERTIES:1,HUB_ACTIONS:2,HUB_ALERTS:3,HUB_ATTACHED_IO:4,ERROR:5,PORT_INPUT_FORMAT_SETUP_SINGLE:65,PORT_INPUT_FORMAT_SETUP_COMBINED:66,PORT_INFORMATION:67,PORT_MODEINFORMATION:68,PORT_VALUE:69,PORT_VALUE_COMBINED:70,PORT_INPUT_FORMAT:71,PORT_INPUT_FORMAT_COMBINED:72,OUTPUT:129,PORT_FEEDBACK:130},PropertyType={ADVERTISEMENT_NAME:1,BUTTON:2,FW_VERSION:3,HW_VERSION:4,RSSI:5,BATTERY_VOLTAGE:6,BATTERY_TYPE:7,MANUFACTURER_NAME:8,RADIO_FW_VERSION:9,LEGO_WP_VERSION:10,SYSTEM_TYPE_ID:11,HW_NETWORK_ID:12,PRIMARY_MAC:13,SECONDARY_MAC:14,HW_NETWORK_FAMILY:15},PropertyOperation={SET:1,ENABLE_UPDATES:2,DISABLE_UPDATES:3,RESET:4,REQUEST_UPDATE:5,UPDATE:6},IOEvent={ATTACHED:1,DETACHED:0,ATTACHED_VIRTUAL:2},MarioMode={COLOR:0,PANTS:0,UNKNOWN:0},MarioColor={WHITE:19,RED:21,BLUE:23,YELLOW:24,BLACK:26,GREEN:37,BROWN:106,PURPLE:268,NOUGAT_BROWN:312,CYAN:322,NONE:-1},MarioPants={NONE:0,BEE:3,LUIGI:5,FROG:6,TANOOKI:10,PROPELLER:12,CAT:17,FIRE:18,PENGUIN:20,MARIO:33,BUILDER:34},numberToInt32Array=o=>{var e=new ArrayBuffer(4),e=new DataView(e);return e.setInt32(0,o),[e.getInt8(3),e.getInt8(2),e.getInt8(1),e.getInt8(0)]};class LEGOMario{constructor(o){this._extensionId=o,this._ports=[],this._sensors={barcode:MarioColor.NONE,color:MarioColor.NONE,pants:MarioPants.NONE},this._ble=null,Scratch.extensions.registerPeripheral(o,this),this._timeoutID=null,this._rateLimiter=new RateLimiter(MarioBLE.sendRateMax),this.reset=this.reset.bind(this),this._onConnect=this._onConnect.bind(this),this._onMessage=this._onMessage.bind(this)}get barcode(){return this._sensors.barcode}get color(){return this._sensors.color}get pants(){return this._sensors.pants}scan(){this._ble&&this._ble.disconnect(),this._ble=new WebBLE(this._extensionId,{filters:[{services:[MarioBLE.service]}]},this._onConnect,this.reset)}connect(o){this._ble&&this._ble.connectPeripheral(o)}disconnect(){this._ble&&this._ble.disconnect(),this.reset()}reset(){this._timeoutID=null,this._ports=[],this._sensors={barcode:MarioColor.NONE,color:MarioColor.NONE,pants:MarioPants.NONE}}isConnected(){let o=!1;return o=this._ble?this._ble.isConnected():o}send(o,e,a=!0){return!this.isConnected()||a&&!this._rateLimiter.okayToSend()?Promise.resolve():void 0}generateInputCommand(o,e,a,r){o=[0,MessageType.PORT_INPUT_FORMAT_SETUP_SINGLE,o,e].concat(numberToInt32Array(a)).concat([r]);return o.unshift(o.length+1),o}_onConnect(){this._ble.startNotifications(MarioBLE.service,MarioBLE.characteristic,this._onMessage),setTimeout(()=>{var o=[0,MessageType.HUB_PROPERTIES,PropertyType.FW_VERSION,PropertyOperation.REQUEST_UPDATE];o.unshift(o.length+1),this.send(MarioBLE.characteristic,o,!1)},500),this._timeoutID=setTimeout(()=>this._ble.handleDisconnectError(BLEDataStoppedError),BLETimeout)}_onMessage(o){var e=Base64Util.base64ToUint8Array(o),o=(console.log(e),e[2]),a=e[3];switch(o){case MessageType.HUB_ATTACHED_IO:var r=e[4],t=e[5];switch(r){case IOEvent.ATTACHED:this._registerSensor(a,t);break;case IOEvent.DETACHED:this._clearPort(a);break;case IOEvent.ATTACHED_VIRTUAL:}break;case MessageType.PORT_VALUE:var r=this._ports[a],i=Buffer.from(e.slice(4));switch(r){case MarioIO.COLOR_BARCODE_SENSOR:this._sensors.barcode=i.readInt16LE(0),this._sensors.color=i.readInt16LE(2);break;case MarioIO.PANTS:this._sensors.pants=i.readInt8(0)}break;case MessageType.ERROR:log.error("Error reported by hub: "+e)}clearTimeout(this._timeoutID),this._timeoutID=setTimeout(()=>this._ble.handleDisconnectError(BLEDataStoppedError),BLETimeout)}_registerSensor(o,e){let a=null,r=1;switch(this._ports[o]=e){case MarioIO.COLOR_BARCODE_SENSOR:a=MarioMode.COLOR,r=0;break;case MarioIO.PANTS:a=MarioMode.PANTS,r=0;break;default:a=MarioMode.UNKNOWN}e=this.generateInputCommand(o,a,r,!0);this.send(MarioBLE.characteristic,e)}_clearPort(o){var e=this._ports[o];e===MarioIO.COLOR_BARCODE_SENSOR&&(this._sensors.barcode=MarioColor.NONE,this._sensors.color=MarioColor.NONE),e===MarioIO.PANTS&&(this._sensors.pants=MarioPants.NONE),this._ports[o]="none"}}class LEGOMarioBlocks{constructor(){this._peripheral=new LEGOMario(LEGOMarioBlocks.EXTENSION_ID)}static get EXTENSION_ID(){return"legomario"}static get ColorLabel(){return{[MarioColor.WHITE]:formatMessage({id:"legomario.color.white",default:"White"}),[MarioColor.RED]:formatMessage({id:"legomario.color.red",default:"Red"}),[MarioColor.BLUE]:formatMessage({id:"legomario.color.blue",default:"Blue"}),[MarioColor.YELLOW]:formatMessage({id:"legomario.color.yellow",default:"Yellow"}),[MarioColor.BLACK]:formatMessage({id:"legomario.color.black",default:"Black"}),[MarioColor.GREEN]:formatMessage({id:"legomario.color.green",default:"Green"}),[MarioColor.BROWN]:formatMessage({id:"legomario.color.brown",default:"Brown"}),[MarioColor.PURPLE]:formatMessage({id:"legomario.color.purple",default:"Purple"}),[MarioColor.NOUGAT_BROWN]:formatMessage({id:"legomario.color.nougatBrown",default:"Nougat Brown"}),[MarioColor.CYAN]:formatMessage({id:"legomario.color.cyan",default:"Cyan"}),[MarioColor.NONE]:formatMessage({id:"legomario.color.noColor",default:"No color"})}}static get PantsLabel(){return{[MarioPants.NONE]:formatMessage({id:"legomario.pants.none",default:"None"}),[MarioPants.BEE]:formatMessage({id:"legomario.pants.bee",default:"Bee"}),[MarioPants.LUIGI]:formatMessage({id:"legomario.pants.luigi",default:"Luigi"}),[MarioPants.FROG]:formatMessage({id:"legomario.pants.frog",default:"Frog"}),[MarioPants.TANOOKI]:formatMessage({id:"legomario.pants.tanooki",default:"Tanooki"}),[MarioPants.PROPELLER]:formatMessage({id:"legomario.pants.propeller",default:"Propeller"}),[MarioPants.CAT]:formatMessage({id:"legomario.pants.cat",default:"Cat"}),[MarioPants.FIRE]:formatMessage({id:"legomario.pants.fire",default:"Fire"}),[MarioPants.PENGUIN]:formatMessage({id:"legomario.pants.penguin",default:"Penguin"}),[MarioPants.MARIO]:formatMessage({id:"legomario.pants.mario",default:"Mario"}),[MarioPants.BUILDER]:formatMessage({id:"legomario.pants.builder",default:"Builder"})}}static get BLOCKS(){return[{opcode:"whenBarcode",text:formatMessage({id:"legomario.whenBarcode",default:"when barcode is [BARCODE]"}),blockType:BlockType.HAT,arguments:{BARCODE:{type:ArgumentType.NUMBER,defaultValue:2}}},{opcode:"whenAnyBarcode",text:formatMessage({id:"legomario.whenAnyBarcode",default:"when any barcode is found"}),blockType:BlockType.HAT},{opcode:"getBarcode",text:formatMessage({id:"legomario.getBarcode",default:"barcode"}),blockType:BlockType.REPORTER},"---",{opcode:"whenColor",text:formatMessage({id:"legomario.whenColor",default:"when color is [SENSOR_COLOR]"}),blockType:BlockType.HAT,arguments:{SENSOR_COLOR:{type:ArgumentType.NUMBER,menu:"SENSOR_COLOR",defaultValue:MarioColor.RED}}},{opcode:"isColor",text:formatMessage({id:"legomario.isColor",default:"color is [SENSOR_COLOR] ?"}),blockType:BlockType.BOOLEAN,arguments:{SENSOR_COLOR:{type:ArgumentType.NUMBER,menu:"SENSOR_COLOR",defaultValue:MarioColor.RED}}},{opcode:"getColor",text:formatMessage({id:"legomario.getColor",default:"color"}),blockType:BlockType.REPORTER},"---",{opcode:"whenPants",text:formatMessage({id:"legomario.whenPants",default:"when pants is [PANTS]"}),blockType:BlockType.HAT,arguments:{PANTS:{type:ArgumentType.NUMBER,menu:"PANTS",defaultValue:MarioPants.FIRE}}},{opcode:"isPants",text:formatMessage({id:"legomario.isPants",default:"pants is [PANTS] ?"}),blockType:BlockType.BOOLEAN,arguments:{PANTS:{type:ArgumentType.NUMBER,menu:"PANTS",defaultValue:MarioPants.MARIO}}},{opcode:"getPants",text:formatMessage({id:"legomario.getPants",default:"pants"}),blockType:BlockType.REPORTER}]}static get MENUS(){return{SENSOR_COLOR:{acceptReporters:!0,items:[{text:formatMessage({id:"legomario.color.white",default:"White"}),value:MarioColor.WHITE},{text:formatMessage({id:"legomario.color.red",default:"Red"}),value:MarioColor.RED},{text:formatMessage({id:"legomario.color.blue",default:"Blue"}),value:MarioColor.BLUE},{text:formatMessage({id:"legomario.color.yellow",default:"Yellow"}),value:MarioColor.YELLOW},{text:formatMessage({id:"legomario.color.black",default:"Black"}),value:MarioColor.BLACK},{text:formatMessage({id:"legomario.color.green",default:"Green"}),value:MarioColor.GREEN},{text:formatMessage({id:"legomario.color.brown",default:"Brown"}),value:MarioColor.BROWN},{text:formatMessage({id:"legomario.color.purple",default:"Purple"}),value:MarioColor.PURPLE},{text:formatMessage({id:"legomario.color.nougatBrown",default:"Nougat Brown"}),value:MarioColor.NOUGAT_BROWN},{text:formatMessage({id:"legomario.color.cyan",default:"Cyan"}),value:MarioColor.CYAN},{text:formatMessage({id:"legomario.color.noColor",default:"No color"}),value:MarioColor.NONE}]},PANTS:{acceptReporters:!0,items:[{text:formatMessage({id:"legomario.pants.none",default:"None"}),value:MarioPants.NONE},{text:formatMessage({id:"legomario.pants.bee",default:"Bee"}),value:MarioPants.BEE},{text:formatMessage({id:"legomario.pants.luigi",default:"Luigi"}),value:MarioPants.LUIGI},{text:formatMessage({id:"legomario.pants.frog",default:"Frog"}),value:MarioPants.FROG},{text:formatMessage({id:"legomario.pants.tanooki",default:"Tanooki"}),value:MarioPants.TANOOKI},{text:formatMessage({id:"legomario.pants.propeller",default:"Propeller"}),value:MarioPants.PROPELLER},{text:formatMessage({id:"legomario.pants.cat",default:"Cat"}),value:MarioPants.CAT},{text:formatMessage({id:"legomario.pants.fire",default:"Fire"}),value:MarioPants.FIRE},{text:formatMessage({id:"legomario.pants.penguin",default:"Penguin"}),value:MarioPants.PENGUIN},{text:formatMessage({id:"legomario.pants.mario",default:"Mario"}),value:MarioPants.MARIO},{text:formatMessage({id:"legomario.pants.builder",default:"Builder"}),value:MarioPants.BUILDER}]}}}getInfo(){return{id:LEGOMarioBlocks.EXTENSION_ID,name:"Mario",blockIconURI:blockIconURI,showStatusButton:!0,blocks:LEGOMarioBlocks.BLOCKS,menus:LEGOMarioBlocks.MENUS}}whenBarcode(o){return this._peripheral.barcode==Cast.toNumber(o.BARCODE)}whenAnyBarcode(){return this._peripheral.barcode!=MarioColor.NONE}getBarcode(){return this._peripheral.barcode}whenColor(o){return this._peripheral.color==Cast.toNumber(o.SENSOR_COLOR)}isColor(o){return this._peripheral.color==Cast.toNumber(o.SENSOR_COLOR)}getColor(){return LEGOMarioBlocks.ColorLabel[this._peripheral.color]||LEGOMarioBlocks.ColorLabel[MarioColor.NONE]}whenPants(o){return this._peripheral.pants==Cast.toNumber(o.PANTS)}isPants(o){return this._peripheral.pants==Cast.toNumber(o.PANTS)}getPants(){return LEGOMarioBlocks.PantsLabel[this._peripheral.pants]||LEGOMarioBlocks.PantsLabel[MarioPants.NONE]}}Scratch.extensions.register(new LEGOMarioBlocks),formatMessage.setup({translations:{en:{"legomario.whenBarcode":"when barcode is [BARCODE]","legomario.whenAnyBarcode":"when any barcode is found","legomario.getBarcode":"barcode","legomario.whenColor":"when color is [SENSOR_COLOR]","legomario.isColor":"color is [SENSOR_COLOR] ?","legomario.getColor":"color","legomario.whenPants":"when pants is [PANTS]","legomario.isPants":"pants is [PANTS] ?","legomario.getPants":"pants","legomario.color.white":"White","legomario.color.red":"Red","legomario.color.blue":"Blue","legomario.color.yellow":"Yellow","legomario.color.black":"Black","legomario.color.green":"Green","legomario.color.brown":"Brown","legomario.color.purple":"Purple","legomario.color.nougatBrown":"Nougat Brown","legomario.color.cyan":"Cyan","legomario.color.noColor":"No color","legomario.pants.none":"None","legomario.pants.bee":"Bee","legomario.pants.luigi":"Luigi","legomario.pants.frog":"Frog","legomario.pants.tanooki":"Tanooki","legomario.pants.propeller":"Propeller","legomario.pants.cat":"Cat","legomario.pants.fire":"Fire","legomario.pants.penguin":"Penguin","legomario.pants.mario":"Mario","legomario.pants.builder":"Builder"},"zh-cn":{"legomario.whenBarcode":"当条形码是[BARCODE]","legomario.whenAnyBarcode":"当扫描到任意条形码","legomario.getBarcode":"条形码","legomario.whenColor":"当颜色是[SENSOR_COLOR]","legomario.isColor":"颜色是[SENSOR_COLOR]?","legomario.getColor":"颜色","legomario.whenPants":"当服装是[PANTS]","legomario.isPants":"服装是[PANTS]?","legomario.getPants":"服装","legomario.color.white":"白色","legomario.color.red":"红色","legomario.color.blue":"蓝色","legomario.color.yellow":"黄色","legomario.color.black":"黑色","legomario.color.green":"绿色","legomario.color.brown":"棕色","legomario.color.purple":"紫色","legomario.color.nougatBrown":"淡棕色","legomario.color.cyan":"青色","legomario.color.noColor":"无色","legomario.pants.none":"无","legomario.pants.bee":"蜜蜂","legomario.pants.luigi":"路易吉","legomario.pants.frog":"青蛙","legomario.pants.tanooki":"狸猫","legomario.pants.propeller":"螺旋桨","legomario.pants.cat":"猫咪","legomario.pants.fire":"火焰","legomario.pants.penguin":"企鹅","legomario.pants.mario":"马力欧","legomario.pants.builder":"建筑工"},"zh-tw":{"legomario.whenBarcode":"當條形碼是[BARCODE]","legomario.whenAnyBarcode":"當掃描到任意條形碼","legomario.getBarcode":"條形碼","legomario.whenColor":"當顏色是[SENSOR_COLOR]","legomario.isColor":"顏色是[SENSOR_COLOR]?","legomario.getColor":"顏色","legomario.whenPants":"當服裝是[PANTS]","legomario.isPants":"服裝是[PANTS]?","legomario.getPants":"服裝","legomario.color.white":"白色","legomario.color.red":"紅色","legomario.color.blue":"藍色","legomario.color.yellow":"黃色","legomario.color.black":"黑色","legomario.color.green":"綠色","legomario.color.brown":"棕色","legomario.color.purple":"紫色","legomario.color.nougatBrown":"淡棕色","legomario.color.cyan":"青色","legomario.color.noColor":"無色","legomario.pants.none":"無","legomario.pants.bee":"蜜蜂","legomario.pants.luigi":"路易吉","legomario.pants.frog":"青蛙","legomario.pants.tanooki":"貍貓","legomario.pants.propeller":"螺旋槳","legomario.pants.cat":"貓咪","legomario.pants.fire":"火焰","legomario.pants.penguin":"企鵝","legomario.pants.mario":"瑪利歐","legomario.pants.builder":"建築工"}}});